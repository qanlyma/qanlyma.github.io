---
title: 「训」 笔记(09)：分布式定时任务
category_bar: true
date: 2023-04-05 15:18:42
tags:
categories: 字节青训
banner_img:
---

自动化 + 定时执行 + 海量数据 + 高效稳定 = 分布式定时任务

<!-- more -->

## 1 概述

定时任务是指系统为了**自动**完成特定任务，**实时、延时、周期性**完成任务调度的过程。

分布式定时任务是把分散的、可靠性差的定时任务纳入统一的平台，并实现集群管理调度和**分布式部署**的一种定时任务的管理方式。

**按触发时机分类**：

* 定时任务：特定时间触发，比如今天 15:06 执行
* 延时任务：延时触发，比如 10s 后执行
* 周期任务：固定周期时间，或固定频率周期调度触发，比如每隔 5s 或者每天 12 点执行

### 1.1 特点

* 自动化：全自动完成定时任务的调度和执行
* 平台化：基于平台化的思维管控一系列的分布式定时任务
* 分布式：在分布式系统环境下运行任务调度，突破单机定时任务的性能瓶颈
* 伸缩性：采用集群方式部署，可以随时按需扩缩容
* 高可用：单点故障不影响最终任务结果，可以做到故障转移

### 1.2 执行模式

* 单机任务：随机触发一台机器执行任务，适用于计算量小、并发度低的任务
* 广播任务：广播到所有机器上执行同一个任务，比如所有机器一起清理日志
* Map 任务：一个任务可以分出多个子任务，每个子任务负责一部分的计算。适用于计算量大，单机无法满足要求的任务
* MapReduce 任务：在 Map 任务的基础上，还可以对所有子任务的结果做汇总计算，适用于计算量大，并且需要对子任务结果做汇总的任务

## 2 实现原理

### 2.1 核心架构

分布式定时任务核心要解决**触发、调度、执行**三个关键问题。

![](1.png)

* 触发器（Trigger）：解析任务，生成触发事件
* 调度器（Scheduler）：分配任务，管理任务生命周期
* 执行器（Executor）：获取执行任务单元，执行任务逻辑
* 控制台（Admin）：提供任务管理和干预的功能。

### 2.2 数据流

![](2.png)

### 2.3 控制台

![](3.png)

* 任务：Job，任务元数据
* 任务实例：Joblnstance，周期任务会生成多个任务实例
* 任务结果：JobResult，任务实例运行的结果
* 任务历史：JobHistory，用户可以修改任务信息，任务实例对应的任务元数据可以不同，因而使用任务历史存储

### 2.4 触发器

给定一系列任务，解析它们的触发规则，在规定的时间点触发任务的调度

**方案一**：定期扫描 + 延时消息（腾讯、字节方案）

![](4.png)

**方案二**：时间轮（Quartz所用方案）

![](5.png)

时间轮是一个存储环形队列，底层采用数组实现，数组中的每个元素可以存放一个定时任务列表。

![](6.png)
![](7.png)
![](8.png)
![](9.png)

### 2.5 调度器

#### 2.5.1 节点选择

* 随机节点执行：选择集群中一个可用的执行节点执行调度任务。适用场景：定时对账。
* 广播执行：在集群中所有的执行节点分发调度任务并执行。适用场景：批量运维。
* 分片执行：按照用户自定义分片逻辑进行拆分，分发到集群中不同节点并行执行，提升资源利用效率。适用场景：海量日志统计。

#### 2.5.2 任务分片

通过任务分片来提高任务执行的效率和资源的利用率。

![](10.png)

#### 2.5.3 任务编排

使用有向无环图 DAG(Directed Acyclic Graph) 进行可视化任务编排。

#### 2.5.4 故障转移

分片任务基于一致性 hash 策略分发任务，当某 Executor 异常时，调度器会将任务分发到其他 Executor。

#### 2.5.5 高可用

调度器可以集群部署，做到完全的无状态，靠消息队列的重试机制保障任务一定会被调度。

### 2.6 执行器

![](11.png)